<!DOCTYPE html>
<html>
<head>
<title>ARBITER PANEL</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
<style>
/* --- LAYOUT & SCROLLING --- */
body {
  background: #0d0d0d;
  color: #e0e0e0;
  font-family: 'Lato', sans-serif;
  margin: 0; padding: 0;
  height: 100vh;
  display: flex; flex-direction: column;
  overflow: hidden;
}

.header {
  height: 60px; background: #111; border-bottom: 1px solid #333;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
h1 {
  margin: 0; color: #FFD700; font-family: 'Cinzel', serif; font-size: 24px;
  text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
}

.main-container {
  height: calc(100vh - 60px); 
  display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; box-sizing: border-box;
}

.card {
  background: #151515; border: 1px solid #333; border-radius: 8px; padding: 15px;
  display: flex; flex-direction: column; height: 100%; overflow: hidden;
  box-sizing: border-box; box-shadow: 0 0 20px rgba(0,0,0,0.5);
}

h3 {
  margin-top: 0; color: #FFD700; font-family: 'Cinzel', serif;
  border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 10px;
  font-size: 16px; flex-shrink: 0;
}

.scroll-area {
  flex-grow: 1; overflow-y: auto;
  border: 1px solid #222; background: #111;
  padding: 10px; margin-bottom: 10px; border-radius: 4px;
}

/* INPUTS & BUTTONS */
.input-group { flex-shrink: 0; }
input, select {
  width: 100%; padding: 12px; margin: 5px 0; background: #222;
  border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box;
}
input:focus, select:focus { border-color: #FFD700; outline: none; background: #2a2a2a; }

button {
  padding: 12px; border: none; background: #333; color: #FFD700;
  font-family: 'Cinzel', serif; font-weight: bold; cursor: pointer;
  border: 1px solid #FFD700; border-radius: 4px; transition: 0.2s; width: 100%;
}
button:hover { background: #FFD700; color: #000; }

.btn-secondary { border-color: #888; color: #aaa; }
.btn-secondary:hover { background: #444; color: #fff; }
.btn-warn { border-color: #ff9800; color: #ff9800; background: transparent; }
.btn-warn:hover { background: #ff9800; color: black; }
.btn-danger { border-color: #ff4444; color: #ff4444; background: transparent; }
.btn-danger:hover { background: #ff4444; color: white; }

.bottom-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: auto; flex-shrink: 0; }
.danger-zone { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; flex-shrink: 0; }

/* FEED ITEMS */
.q-row { background: #1e1e1e; padding: 10px; margin-bottom: 8px; border-left: 3px solid #555; border-radius: 0 4px 4px 0; }
.q-row.active { border-left-color: #FFD700; background: #252525; }
.q-meta { font-size: 11px; color: #888; display: flex; justify-content: space-between; margin-bottom: 4px; }
.round-divider { text-align: center; margin: 15px 0; color: #FFD700; font-family: 'Cinzel', serif; font-size: 14px; border-bottom: 1px dashed #444; line-height: 0.1em; }
.round-divider span { background: #111; padding: 0 10px; }
.log-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #222; font-size: 13px; }
.log-actions button { padding: 4px 8px; font-size: 10px; margin-left: 5px; width: auto; }

#toast { position: fixed; top: 20px; right: 20px; background: #FFD700; color: #000; padding: 12px 24px; border-radius: 4px; font-weight: bold; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 1000; }
#toast.show { opacity: 1; }
</style>
</head>
<body>

<div class="header">
  <h1>â™” ARBITER CONTROL</h1>
</div>
<div id="toast">Action Saved</div>

<div class="main-container">

  <div class="card">
    <h3>âš” LIVE INPUT</h3>
    
    <div class="scroll-area" id="inputFeed">
      <div class="round-divider"><span>ROUND 1</span></div>
    </div>

    <div style="margin-top:auto;">
        <button onclick="addNewRound()" class="btn-secondary" style="margin-bottom:10px;">+ NEW ROUND</button>
        <div class="bottom-controls">
            <button onclick="addEntrySameQ()" style="font-size:12px;">+ ENTRY (SAME Q)</button>
            <button onclick="addNextQ()">+ NEXT QUESTION</button>
        </div>
    </div>
  </div>

  <div class="card">
    <div class="input-group" style="display:flex; gap:10px; margin-bottom:15px;">
      <input id="newTeamName" placeholder="New Faction Name" onkeydown="handleTeamEnter(event)">
      <button onclick="registerTeam()" style="width:auto;">ADD</button>
    </div>

    <h3>ðŸ“œ ACTION LOG</h3>
    <div class="scroll-area" id="logFeed"></div>

    <div class="input-group">
      <button onclick="window.open('/downloadSheet')" style="margin-top:5px;">â¬‡ EXCEL SHEET</button>
      <div class="danger-zone">
        <button class="btn-warn" onclick="resetElo()">â†º REMATCH (RESET)</button>
        <button class="btn-danger" onclick="wipeTournament()">â˜  GAMBIT (WIPE)</button>
      </div>
    </div>
  </div>

</div>

<script>
let currentRound = 1;
let currentQ = 0;
let teamOptionsHTML = "";

async function init() {
  await loadTeams();
  addNextQ(); // Start with Q1 inputs ready
  loadLogs();
}

function showToast(msg) {
  const t = document.getElementById("toast");
  t.innerText = msg; t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2000);
}

/* --- TEAMS --- */
async function loadTeams() {
  try {
    const res = await fetch("/teams");
    if (!res.ok) return; // Silent fail
    const data = await res.json();
    teamOptionsHTML = data.map(t => `<option value="${t.name}">${t.name}</option>`).join("");
    // Refresh all active selects
    document.querySelectorAll("select.team-select").forEach(s => { 
      if (!s.disabled) s.innerHTML = teamOptionsHTML; 
    });
  } catch (e) { console.error("Team load error", e); }
}

function handleTeamEnter(e) { if(e.key === "Enter") registerTeam(); }

async function registerTeam() {
  const name = document.getElementById("newTeamName").value.trim();
  if (!name) return;
  
  try {
    const res = await fetch("/addTeam", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name }) });
    if (res.ok) {
      document.getElementById("newTeamName").value = "";
      showToast("Faction Registered");
      loadTeams();
    } else {
      alert("Error adding team. Check database.");
    }
  } catch (e) { alert("Network Error: " + e.message); }
}

/* --- INPUT UI LOGIC --- */
function addNewRound() {
  currentRound++; 
  currentQ = 0;
  const feed = document.getElementById("inputFeed");
  const div = document.createElement("div");
  div.className = "round-divider"; div.innerHTML = `<span>ROUND ${currentRound}</span>`;
  feed.appendChild(div);
  feed.scrollTop = feed.scrollHeight;
  addNextQ();
}

function addNextQ() {
  currentQ++;
  createInputRow();
}

function addEntrySameQ() {
  if(currentQ === 0) currentQ = 1; 
  createInputRow();
}

function createInputRow() {
  const feed = document.getElementById("inputFeed");
  const id = Date.now();
  const div = document.createElement("div");
  div.className = "q-row active"; div.id = `row_${id}`;
  div.innerHTML = `
    <div class="q-meta"><span>R${currentRound} - Q${currentQ}</span><span style="color:#FFD700; cursor:pointer;" onclick="removeInput('${id}')">âœ•</span></div>
    <select id="team_${id}" class="team-select">${teamOptionsHTML}</select>
    <div style="display:flex; gap:5px;">
      <input type="number" id="points_${id}" placeholder="Points (+/-)" onkeydown="handleEnter(event, ${id})">
      <button onclick="submitRow(${id})" style="width:auto; padding:0 15px;">âœ”</button>
    </div>
  `;
  feed.appendChild(div);
  feed.scrollTop = feed.scrollHeight;
  setTimeout(() => document.getElementById(`points_${id}`).focus(), 50);
}

function removeInput(id) { document.getElementById(`row_${id}`)?.remove(); }
function handleEnter(e, id) { if (e.key === "Enter") submitRow(id); }

/* --- CORE SUBMISSION LOGIC --- */
async function submitRow(id) {
  const team = document.getElementById(`team_${id}`).value;
  const points = document.getElementById(`points_${id}`).value;
  const row = document.getElementById(`row_${id}`);
  
  if (!team || points === "") return;
  
  // 1. Lock UI
  row.classList.remove("active"); row.style.opacity = "0.6";
  row.querySelectorAll("input, select, button").forEach(el => el.disabled = true);
  
  try {
    // 2. Send to Server
    const res = await fetch("/logQuestion", { 
      method: "POST", 
      headers: { "Content-Type": "application/json" }, 
      body: JSON.stringify({ question: currentQ, team, points: Number(points), roundLabel: `R${currentRound}` }) 
    });

    if (!res.ok) throw new Error("Server rejected save");

    // 3. Success Feedback
    showToast(`Saved: ${team} (${points})`);
    loadLogs(); 
    
  } catch (err) {
    // 4. Error Handling: Re-enable UI
    alert("FAILED TO SAVE! Is the database set up?\nError: " + err.message);
    row.classList.add("active"); row.style.opacity = "1";
    row.querySelectorAll("input, select, button").forEach(el => el.disabled = false);
  }
}

/* --- LOGS --- */
async function loadLogs() {
  try {
    const res = await fetch("/questionLogs");
    if (!res.ok) return;
    const data = await res.json();
    const feed = document.getElementById("logFeed");
    feed.innerHTML = "";
    data.forEach(log => {
      const div = document.createElement("div");
      div.className = "log-item";
      const color = log.points >= 0 ? "#FFD700" : "#ff4444";
      div.innerHTML = `
        <div><span style="color:#666; margin-right:5px;">${log.round_label || 'Q'+log.question}</span><b>${log.team}</b></div>
        <div style="display:flex; align-items:center;">
          <span style="color:${color}; font-weight:bold; margin-right:10px;">${log.points}</span>
          <div class="log-actions"><button onclick="editLog(${log.id}, ${log.points})">âœŽ</button><button class="btn-danger" onclick="deleteLog(${log.id})">âœ•</button></div>
        </div>
      `;
      feed.appendChild(div);
    });
  } catch(e) { console.error("Log load failed", e); }
}

async function editLog(id, oldVal) {
  const newVal = prompt("Enter corrected score:", oldVal);
  if (newVal === null) return;
  try {
    await fetch("/updateLog", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ id, newPoints: Number(newVal) }) });
    loadLogs(); showToast("Log Updated");
  } catch(e) { alert("Update failed"); }
}

async function deleteLog(id) {
  if (!confirm("Permanently delete this entry?")) return;
  try {
    await fetch("/deleteLog", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ id }) });
    loadLogs(); showToast("Entry Deleted");
  } catch(e) { alert("Delete failed"); }
}

async function resetElo() {
  if (prompt("Type 'DRAW' to reset all scores:") === "DRAW") {
    await fetch("/resetScores", { method: "POST" }); showToast("Elo Reset"); loadLogs();
  }
}

async function wipeTournament() {
  if (prompt("Type 'GAMBIT' to wipe ALL:") === "GAMBIT") {
    await fetch("/resetTournament", { method: "POST" }); location.reload();
  }
}

setInterval(loadLogs, 5000);
init();
</script>
</body>
</html>