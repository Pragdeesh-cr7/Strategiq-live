<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STRATEGIQ: THE GRANDMASTER CIRCUIT</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Montserrat:wght@400;600;800&family=Orbitron:wght@500;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
<style>
/* -----------------------------------------------------------
   1. GLOBAL RESET & VARIABLES
   ----------------------------------------------------------- */
:root {
  /* COLORS */
  --gold: #FFD700;
  --gold-dim: #C5A000;
  --gold-glow: rgba(255, 215, 0, 0.5);
  --silver: #E0E0E0;
  --bronze: #CD7F32;
  --black-deep: #050505;
  --black-panel: rgba(15, 15, 20, 0.7);
  
  --neon-green: #00ff9d;
  --neon-red: #ff3333;
  --glass-border: rgba(255, 215, 0, 0.15);
  
  /* FONTS */
  --font-title: 'Cinzel', serif;
  --font-data: 'Orbitron', sans-serif;
  --font-body: 'Montserrat', sans-serif;
  
  /* ANIMATION SETTINGS */
  --reveal-delay: 1s; /* 1 second gap as requested */
  --anim-speed: 0.8s;
  --anim-curve: cubic-bezier(0.34, 1.56, 0.64, 1); /* Bouncy physics */
}

* { box-sizing: border-box; user-select: none; }

body {
  margin: 0;
  padding: 0;
  background-color: var(--black-deep);
  color: #fff;
  font-family: var(--font-body);
  height: 100vh;
  width: 100vw;
  overflow: hidden; /* No scrolling allowed */
  display: flex;
  flex-direction: column;
}

/* -----------------------------------------------------------
   2. BACKGROUND CANVAS (PARTICLE ENGINE)
   ----------------------------------------------------------- */
#bg-canvas {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: -1;
  background: radial-gradient(circle at 50% 10%, #1a1a1a 0%, #000000 90%);
}

.overlay-grid {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background-image: 
    linear-gradient(rgba(255,215,0,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,215,0,0.03) 1px, transparent 1px);
  background-size: 80px 80px;
  z-index: -1;
  pointer-events: none;
  mask-image: linear-gradient(to bottom, black 20%, transparent 90%);
}

/* -----------------------------------------------------------
   3. HEADER SECTION
   ----------------------------------------------------------- */
.header {
  flex-shrink: 0; /* Don't shrink */
  height: 140px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: relative;
  z-index: 10;
  padding-top: 20px;
  text-shadow: 0 0 30px rgba(0,0,0,0.9);
}

.header-title-row {
  display: flex;
  align-items: center;
  gap: 20px;
}

.main-title {
  font-family: var(--font-title);
  font-size: 64px;
  color: var(--gold);
  margin: 0;
  letter-spacing: 15px;
  text-transform: uppercase;
  background: linear-gradient(to bottom, #FFD700 0%, #B8860B 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.3));
}

.sub-title {
  font-family: var(--font-data);
  color: #888;
  font-size: 14px;
  letter-spacing: 8px;
  text-transform: uppercase;
  margin-top: 5px;
  opacity: 0.8;
}

/* -----------------------------------------------------------
   4. LEADERBOARD GRID (THE 6 TEAMS)
   ----------------------------------------------------------- */
.board-container {
  flex-grow: 1; /* Takes all remaining height */
  width: 90%;
  max-width: 1600px;
  margin: 0 auto 20px auto; /* Bottom padding */
  position: relative;
  perspective: 1000px;
}

/* The Row Card */
.row {
  position: absolute;
  left: 0; right: 0;
  /* Calculate height: we have 6 teams. 
     We leave some gap. 
     Calc: (100% / 6) minus gap adjustment */
  height: calc((100% / 6) - 15px); 
  
  display: grid;
  grid-template-columns: 80px 80px 3fr 1fr; /* Rank | Icon | Name/Bar | Score */
  align-items: center;
  gap: 20px;
  padding: 0 40px;
  
  /* Glassmorphism */
  background: var(--black-panel);
  backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  
  /* Transitions */
  transition: top var(--anim-speed) var(--anim-curve), 
              transform 0.4s ease,
              border-color 0.4s ease;
  
  /* Initial State (Hidden for Reveal) */
  opacity: 0;
  transform: translateX(-100px) scale(0.9);
}

/* Revealed State */
.row.revealed {
  opacity: 1;
  transform: translateX(0) scale(1);
  transition: top var(--anim-speed) var(--anim-curve), 
              opacity 1s ease, 
              transform 1s var(--anim-curve);
}

/* -----------------------------------------------------------
   5. RANK STYLING (Gold/Silver/Bronze/Others)
   ----------------------------------------------------------- */
.rank-num {
  font-family: var(--font-data);
  font-size: 32px;
  font-weight: 900;
  color: #555;
  text-align: center;
  position: relative;
}

/* Rank 1 Specifics */
.row.rank-1 {
  background: linear-gradient(90deg, rgba(255,215,0,0.15) 0%, rgba(5,5,5,0.9) 100%);
  border: 2px solid var(--gold);
  box-shadow: 0 0 30px rgba(255, 215, 0, 0.15), inset 0 0 30px rgba(255, 215, 0, 0.05);
  z-index: 10;
}
.row.rank-1 .rank-num { color: var(--gold); text-shadow: 0 0 20px var(--gold); font-size: 42px; }
.row.rank-1 .piece-icon { filter: drop-shadow(0 0 10px var(--gold)); transform: scale(1.2); }
.row.rank-1 .team-name { color: #fff; text-shadow: 0 0 10px var(--gold); }

/* Rank 2 Specifics */
.row.rank-2 { border-left: 6px solid var(--silver); }
.row.rank-2 .rank-num { color: var(--silver); }

/* Rank 3 Specifics */
.row.rank-3 { border-left: 6px solid var(--bronze); }
.row.rank-3 .rank-num { color: var(--bronze); }

/* -----------------------------------------------------------
   6. INNER CONTENT (Name, Bar, Score, Trends)
   ----------------------------------------------------------- */
.piece-icon {
  font-size: 40px;
  text-align: center;
  color: #fff;
  opacity: 0.9;
}

.info-group {
  display: flex;
  flex-direction: column;
  justify-content: center;
  height: 100%;
}

.name-row {
  display: flex;
  align-items: baseline;
  gap: 15px;
  margin-bottom: 8px;
}

.team-name {
  font-size: 28px;
  font-weight: 800;
  text-transform: uppercase;
  color: #e0e0e0;
  letter-spacing: 1px;
}

.team-title {
  font-family: var(--font-data);
  font-size: 10px;
  background: rgba(255,255,255,0.1);
  padding: 4px 8px;
  border-radius: 4px;
  color: #aaa;
  letter-spacing: 2px;
}
.row.rank-1 .team-title { background: var(--gold); color: #000; font-weight: bold; }

/* BAR CHART */
.bar-container {
  width: 100%;
  height: 6px;
  background: rgba(255,255,255,0.1);
  border-radius: 3px;
  overflow: hidden;
  position: relative;
}
.bar-fill {
  height: 100%;
  width: 0%; /* JS sets this */
  background: #555;
  transition: width 1s ease-out;
  position: relative;
}
/* Bar Colors per rank */
.row.rank-1 .bar-fill { background: var(--gold); box-shadow: 0 0 10px var(--gold); }
.row.rank-2 .bar-fill { background: var(--silver); }
.row.rank-3 .bar-fill { background: var(--bronze); }

/* SCORE & TRENDS */
.score-group {
  text-align: right;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  justify-content: center;
}

.score-val {
  font-family: var(--font-data);
  font-size: 40px;
  font-weight: 900;
  color: #fff;
  line-height: 1;
}

/* Negative Score Handling */
.score-val.negative {
  color: var(--neon-red);
  text-shadow: 0 0 15px rgba(255, 51, 51, 0.6);
}

.trend-box {
  height: 20px; /* fixed height to prevent jumping */
  display: flex;
  align-items: center;
  justify-content: flex-end;
  margin-top: 5px;
}

.trend-pill {
  font-family: var(--font-data);
  font-size: 12px;
  font-weight: bold;
  padding: 2px 8px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  gap: 5px;
  animation: fadeIn 0.5s ease;
}

.trend-up { background: rgba(0, 255, 157, 0.1); color: var(--neon-green); border: 1px solid var(--neon-green); }
.trend-down { background: rgba(255, 51, 51, 0.1); color: var(--neon-red); border: 1px solid var(--neon-red); }

/* -----------------------------------------------------------
   7. ANIMATIONS
   ----------------------------------------------------------- */
@keyframes floatIcon {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

</style>
</head>
<body>

<canvas id="bg-canvas"></canvas>
<div class="overlay-grid"></div>

<div class="header">
  <div class="header-title-row">
    <h1 class="main-title">STRATEGIQ</h1>
  </div>
  <div class="sub-title">GRANDMASTER CIRCUIT</div>
</div>

<div class="board-container" id="board">
  </div>

<script>
/** ------------------------------------------------------------------
 * 1. CANVAS PARTICLE SYSTEM (VISUALS)
 * ------------------------------------------------------------------ */
const canvas = document.getElementById('bg-canvas');
const ctx = canvas.getContext('2d');
let w, h;
const particles = [];

function resize() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
window.addEventListener('resize', resize);
resize();

class Particle {
  constructor() {
    this.reset();
    this.y = Math.random() * h; // Initial random scatter
  }
  reset() {
    this.x = Math.random() * w;
    this.y = h + Math.random() * 100;
    this.v = Math.random() * 0.5 + 0.1;
    this.size = Math.random() * 2;
    this.alpha = Math.random() * 0.5 + 0.1;
  }
  update() {
    this.y -= this.v;
    if(this.y < -10) this.reset();
  }
  draw() {
    ctx.fillStyle = `rgba(255, 215, 0, ${this.alpha})`;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fill();
  }
}
// Create dust particles
for(let i=0; i<60; i++) particles.push(new Particle());

function animate() {
  ctx.clearRect(0,0,w,h);
  particles.forEach(p => { p.update(); p.draw(); });
  requestAnimationFrame(animate);
}
animate();

/** ------------------------------------------------------------------
 * 2. GAME LOGIC & RENDERING
 * ------------------------------------------------------------------ */

// CONFIG
const MAX_TEAMS = 6;
const BASE_ELO = 1000; // Baseline for bar chart 0%

// STATE
let isFirstLoad = true;
let previousRanks = {}; // Map: TeamName -> RankIndex

// HELPER: Get Title based on Rank (Not Score)
function getTitle(index) {
  const titles = [
    "GRANDMASTER",      // 1
    "INTL. MASTER",     // 2
    "FIDE MASTER",      // 3
    "NATIONAL MASTER",  // 4
    "CANDIDATE MASTER", // 5
    "EXPERT"            // 6
  ];
  return titles[index] || "PLAYER";
}

// HELPER: Get Icon based on Rank
function getIcon(index) {
  if (index === 0) return '♔'; // King
  if (index === 1) return '♕'; // Queen
  if (index === 2) return '♖'; // Rook
  if (index === 3) return '♗'; // Bishop
  if (index === 4) return '♘'; // Knight
  return '♙'; // Pawn
}

async function updateBoard() {
  try {
    const res = await fetch("/scores");
    if(!res.ok) return;
    let data = await res.json();
    
    // Ensure we only take top 6 if there are more
    data = data.slice(0, MAX_TEAMS);

    const board = document.getElementById("board");
    
    // Determine Max Score for Bar Chart scaling
    // FIXED: Adjusted for 0-based scoring (minimum 50 to avoid big bars for small scores)
    const highestScore = data.length > 0 ? Math.max(data[0].score, 50) : 50;

    data.forEach((team, index) => {
      // 1. Calculate Trend
      // Compare current index with previous index
      let trendHTML = '';
      const oldIndex = previousRanks[team.name];
      
      // If we have history, and it's not the first load (to avoid instant arrows)
      if (oldIndex !== undefined && !isFirstLoad) {
        if (index < oldIndex) {
          // Moved UP (Rank number got smaller)
          trendHTML = `<div class="trend-pill trend-up">▲ UP</div>`;
        } else if (index > oldIndex) {
          // Moved DOWN (Rank number got bigger)
          trendHTML = `<div class="trend-pill trend-down">▼ DOWN</div>`;
        }
      }

      // 2. Bar Chart Logic
      let barWidth = 0;
      if (team.score > 0) {
        // Simple linear scale from 0 to maxScore
        barWidth = (team.score / highestScore) * 100;
      }
      // Cap at 100
      barWidth = Math.min(Math.max(barWidth, 0), 100);

      // 3. Negative Score Class
      const scoreClass = team.score < 0 ? "score-val negative" : "score-val";

      // 4. HTML Generation
      // Check if row exists
      let row = document.getElementById(`team-${team.name}`);
      const isNew = !row;
      
      const rankClass = index === 0 ? "rank-1" : 
                        index === 1 ? "rank-2" : 
                        index === 2 ? "rank-3" : "rank-rest";

      const htmlContent = `
        <div class="rank-num">#${index + 1}</div>
        <div class="piece-icon">${getIcon(index)}</div>
        <div class="info-group">
          <div class="name-row">
            <div class="team-name">${team.name}</div>
            <div class="team-title">${getTitle(index)}</div>
          </div>
          <div class="bar-container">
            <div class="bar-fill" style="width: ${barWidth}%"></div>
          </div>
        </div>
        <div class="score-group">
          <div class="${scoreClass}">${team.score}</div>
          <div class="trend-box">${trendHTML}</div>
        </div>
      `;

      if (isNew) {
        row = document.createElement("div");
        row.id = `team-${team.name}`;
        row.className = `row ${rankClass}`;
        row.innerHTML = htmlContent;
        board.appendChild(row);

        // REVEAL LOGIC: Staggered with 1s gap
        if (isFirstLoad) {
          setTimeout(() => {
            row.classList.add("revealed");
          }, index * 1000); // 1000ms = 1 second gap per team
        } else {
          // If added later, just appear
          requestAnimationFrame(() => row.classList.add("revealed"));
        }

      } else {
        // Update existing row
        row.className = `row ${rankClass} revealed`;
        row.innerHTML = htmlContent;
      }

      // 5. Positioning (The "No Scroll" Magic)
      // Percentage based position: (100% / 6) * index
      // This ensures 6 items fit perfectly in height
      const rowHeightPercent = 100 / 6;
      row.style.top = `calc(${index * rowHeightPercent}% + 10px)`; 
      // +10px creates a small top margin within the allocated slot
    });

    // Update Rank History for next cycle
    const newRankMap = {};
    data.forEach((t, i) => newRankMap[t.name] = i);
    previousRanks = newRankMap;

    // Turn off first load flag after the longest possible delay (6 teams * 1s = 6s)
    if(isFirstLoad) {
      setTimeout(() => { isFirstLoad = false; }, 6500);
    }

  } catch (err) {
    console.error(err);
  }
}

// Start Engine
updateBoard();
setInterval(updateBoard, 2000); // Poll every 2 seconds

</script>
</body>
</html>
